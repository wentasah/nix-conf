#!/usr/bin/env bash

# Script to rebuild my system(s) when something changes. I'm running
# this from a cron job on a server.
#
# Usage: nix-conf [update|build] [nix build options]
#
# With no sub-command, update is implied.
#
# Example: nix-conf build --log-format raw

set -euo pipefail

was_head_changed() {
    local old_tree=$(git rev-parse HEAD^{tree})
    "$@" || exit 1
    local new_tree=$(git rev-parse HEAD^{tree})
    if [[ $old_tree != $new_tree ]]; then
        echo "!!! Tree hash in $PWD changed from $old_tree to $new_tree"
        return 0
    fi
    return 1
}

exit_if_dirty() {
    if ! git diff-index --quiet HEAD --; then
        echo >&2 "$PWD dirty!"
        exit 1
    fi
}

update_nix_conf() {
    cd ~/nix/conf
    local flake_lock_dirty=0
    if ! git diff --quiet flake.lock; then
        git stash push -- flake.lock # Dirty flake.lock can prevent git pull
        flake_lock_dirty=1
    fi
        # The following must be on a single line so that update of the script via git pull works.
    if was_head_changed git pull --quiet https://github.com/wentasah/nix-conf.git; then
        WAS_RERUN=0 exec $0
    fi
    if [[ $flake_lock_dirty == 1 ]] && ! git stash pop --quiet; then
        # Don't try to resolve the conflict. In the worst case, we'll
        # run an unnecessary rebuild.
        git restore flake.lock
        git stash drop
    fi
    # Git repo was not changed - report the result based on the value of RERUN variable.
    local ret=${WAS_RERUN:-1}
    unset WAS_RERUN
    return "$ret"
}

merge_nixpkgs_topics_into_master() {
    cd ~/nix/nixpkgs

    git checkout --quiet master
    git reset --keep nixos-unstable

    local commit_msg='automatic merge by nix-conf'
    if [[ -f .git/machete ]]; then
        # On my laptop - merge all non-root branches managed by git-machete
        readarray -t to_merge < <(sed -nE '/^[[:space:]]+([^ ]*).*/ s//\1/p' .git/machete)
        commit_msg+=$'\n'$'\n'"Merged branches:${to_merge[@]/#/$'\n'- }"
    else
        # CI: Recreate the merge from HEAD of my repo
        ## git fetch . test
        if [[ $(git show wentasah/master) == *"$commit_msg"* ]]; then
            readarray -t to_merge < <(git cat-file -p wentasah/master | sed -ne '/^parent / s///p')
            commit_msg=$(git show --format='%B' --no-patch wentasah/master) # Use the same commit message
        else
            echo >&2 "HEAD of $(git config remote.wentasah.url) is not a merge commit created by nix-conf"
            exit 1
        fi
    fi
    git merge --quiet --no-ff --no-commit "${to_merge[@]}"
    GIT_AUTHOR_DATE=$(git show nixos-unstable --format='%aD') \
    GIT_COMMITTER_DATE=$(git show nixos-unstable --format='%cD') \
    git commit -m "$commit_msg"
}

update_nixpkgs() {
    cd ~/nix/nixpkgs
    exit_if_dirty

    update_nixpkgs_and_merge_topics() {
        git fetch --quiet origin
        git fetch --quiet wentasah
        git update-ref refs/heads/nixos-unstable origin/nixos-unstable
        merge_nixpkgs_topics_into_master
    }

    was_head_changed update_nixpkgs_and_merge_topics \
        && echo "nixpkgs upstream commit: $(git rev-parse origin/nixos-unstable)"
}

update_home_manager() {
    cd ~/nix/home-manager
    was_head_changed git pull --quiet
}

update_flake_input() {
    cd ~/nix/conf
    local flake_input=$1
    local old_hash=$(git hash-object flake.lock)
    nix flake lock --update-input "$flake_input"
    local new_hash=$(git hash-object flake.lock)
    if [[ $old_hash != $new_hash ]]; then
        echo "!!! Flake input $flake_input changed"
        return 0
    fi
    return 1
}

updated() {
    local result=1
    update_nix_conf && result=0
    #update_home_manager && result=0
    update_nixpkgs && result=0
    # Update nixpkgs-stable, but don't trigger rebuild of unstable
    # stuff (i.e. result=0). `nix flake check` will then rebuild stable
    update_flake_input nixpkgs-stable
    if [[ $result = 0 ]]; then
        # Reset failed build counter
        rm -f ~/nix/out/"$HOST"/flake.retry.cnt
        # Update selected overlays only if something else is updated
        update_flake_input emacs-overlay
        update_flake_input nix-index-database
    fi
    return $result
}

failed_recently() {
    cnt=~/nix/out/$HOST/flake.retry.cnt
    if [[ -s ~/nix/out/$HOST/flake.error ]] &&
       [[ $(cat $cnt) -lt 2 ]]; then
        echo $(( $(cat $cnt) + 1 )) > $cnt
        return 0
    else
        return 1
    fi
}

print_switch_instructions() {
    local override_input=$1
    echo "Diff from current configuration:"
    nix store diff-closures /run/current-system ~/nix/out/"$HOST"/flake
    echo
    echo "Run one of the following to switch the configuration:"
    echo "  sudo nix-conf switch"
    echo "  sudo nixos-rebuild switch $override_input"
}

build() {
    cd ~/nix

    PATH=/nix/var/nix/profiles/default/bin:$PATH
    local old_version=$(readlink out/"$HOST"/flake || :)
    local override_input=
    case "$HOST" in
        steelpick) override_input="--override-input nixpkgs $PWD/nixpkgs";;
    esac
    if [[ -f conf/flake.nix ]]; then
        local status=0
        (
            mkdir -p out/"$HOST"
            local nix=nix
            if ! tty -s; then
                exec > out/"$HOST"/flake.log 2>&1
            else
                echo "No log from interactive session" > out/"$HOST"/flake.log
                command -v nom &> /dev/null && nix=nom
            fi
            $nix build \
                "$@" \
                --out-link out/"$HOST"/flake $override_input \
                ./conf#nixosConfigurations."$HOST".config.system.build.toplevel
        ) || status=$?
        if [[ $status -eq 0 ]]; then
            : > out/"$HOST"/flake.error
            # Reset failed build counter
            rm -f out/"$HOST"/flake.retry.cnt
        else
            # we use cat instead of mv to not break hardlinks to the flake.error
            cat out/"$HOST"/flake.log > out/"$HOST"/flake.error
            touch out/"$HOST"/flake.retry.cnt
            exit $status
        fi

        if [[ $(hostname) = "$HOST" ]]; then
            print_switch_instructions "$override_input"
        else
            (
                cp conf/flake.lock out/"$HOST"

                cd nixpkgs
                if git diff --quiet wentasah/ci; then
                    return
                fi
                git push --force wentasah HEAD:ci

	        local old_commit=$(git rev-parse history)
	        local new_commit=$(git commit-tree -p "$old_commit" -p HEAD "HEAD^{tree}" -m "update history branch")
	        git update-ref refs/heads/history "$new_commit" "$old_commit"
                git push wentasah history
            )
            if [[ $old_version != $(readlink out/"$HOST"/flake) ]]; then
                matrix-commander --markdown -m "nix-conf CI update completed

$(nix store diff-closures $old_version out/"$HOST"/flake | ansifilter | sed -e 's/^/    /')" || :
            fi
        fi
    else
        export NIX_PATH=nixpkgs=$PWD/nixpkgs:nixos-hardware=$PWD/nixos-hardware
        export NIXOS_CONFIG=$PWD/conf/$HOST/configuration.nix

        mkdir -p out/"$HOST"/nixos
        (
            cd out/"$HOST"/nixos
            nix-shell -p nixos-rebuild --run "nixos-rebuild build --keep-going"
        )

        mkdir -p out/"$HOST"/home
        (
            cd out/"$HOST"/home
            nix-shell -E 'with import <nixpkgs> { }; runCommand "dummy" { buildInputs = [ (import ~/nix/home-manager {}).home-manager ]; } ""' \
                      --run "home-manager build --keep-going -f ~/nix/conf/$HOST/home.nix"
        )
    fi
}

switch() {
    local O="/home/${SUDO_USER:-$USER}/nix/out/$HOST/flake"
    nix-env -p /nix/var/nix/profiles/system --set "$O"
    "$O"/bin/switch-to-configuration "${1:-switch}"
}

push() {
    cd ~/nix/nixpkgs
    git push --force-with-lease wentasah master:master
    git push wentasah nixos-unstable:nixos-unstable
    cd ~/nix/conf
    nix flake lock --update-input nixpkgs --commit-lock-file
    git push
}

add_commits() {
    local branch="${1:?no branch given}";
    shift
    git checkout -B "$branch" nixos-unstable
    git cherry-pick "${@:?no commits specified}"
    git-machete add
    merge_nixpkgs_topics_into_master
}

add_pr() {
    local pr="${1:?no PR number given}";
    local branch="${2:?no branch given}-pr-$pr";
    git fetch origin master staging
    git fetch origin refs/pull/"$pr"/head
    if git merge-base --is-ancestor nixos-unstable FETCH_HEAD; then
        # Rebase PR's commits on nixos-unstable
        # shellcheck disable=SC2046
        add_commits "$branch" $(gh pr view --json commits "$pr" | jq --raw-output '.commits[].oid')
    else
        # Merge PR's commits
        git branch "$branch" FETCH_HEAD
        git-machete add "$branch"
        merge_nixpkgs_topics_into_master
    fi
    git-machete anno --branch="$branch" "PR #$pr rebase=no push=no"
}

update() {
    if updated || failed_recently; then
        build "$@"
    else
        echo "Nothing to do for update."
    fi
}

if [[ ${1:-} ]] && [[ $1 != -* ]]; then
    cmd=$1
    shift
else
    cmd=update
fi

export GIT_AUTHOR_NAME=nix-conf
export GIT_AUTHOR_EMAIL=nix-conf@localhost
export GIT_COMMITTER_NAME=nix-conf
export GIT_COMMITTER_EMAIL=nix-conf@localhost

# For which host to build the configuration
HOST=${HOST:-$(hostname)}

case "$cmd" in
    "update")
        update "$@";;
    "ci")
        update "$@"
        if ! nix flake check ~/nix/conf --override-input nixpkgs ~/nix/nixpkgs; then
           echo "nix flake check failed!!!" | tee -a ~/nix/out/"$HOST"/flake.error
           exit 1
        fi;;
    "build")
        build "$@";;
    "copy")
        update_nixpkgs || :
        rsync ritchie:nix/out/steelpick/flake.lock ~/nix/conf
        O=$(ssh ritchie readlink nix/out/steelpick/flake)
        nix copy -j16 --from ssh://ritchie "$O"
        ln -sfn "$O" ~/nix/out/"$HOST"/flake
        print_switch_instructions "TODO"
        ;;
    "merge")
        merge_nixpkgs_topics_into_master;;
    "switch")
        switch;;
    "boot")
        switch boot;;
    "push")
        push;;
    "add-pr")
        add_pr "$@";;
    "add-commits")
        add_commits "$@";;
    *)
        echo >&2 "Unknown command: $cmd"
esac
